generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Team {
  id               String             @id
  name             String
  conference       String
  division         String?
  logoUrl          String?            @map("logo_url")
  primaryColor     String?            @map("primary_color")
  secondaryColor   String?            @map("secondary_color")
  mascot           String?
  city             String?
  state            String?
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  awayGames        Game[]             @relation("AwayTeam")
  homeGames        Game[]             @relation("HomeTeam")
  powerRatings     PowerRating[]
  recruiting       Recruiting[]
  teamSeasonTalent TeamSeasonTalent[]
  teamClassCommits TeamClassCommits[]
  teamGameStats    TeamGameStat[]
  memberships      TeamMembership[]
  injuries         Injury[]
  rankings         TeamRanking[]
  marketLines      MarketLine[]
  teamGameAdj      TeamGameAdj[]
  homeTrainingRows GameTrainingRow[]  @relation("HomeTrainingRows")
  awayTrainingRows GameTrainingRow[]  @relation("AwayTrainingRows")

  @@index([conference, division])
  @@index([name])
  @@map("teams")
}

model Game {
  id             String            @id
  homeTeamId     String            @map("home_team_id")
  awayTeamId     String            @map("away_team_id")
  season         Int
  week           Int
  date           DateTime
  status         GameStatus
  homeScore      Int?              @map("home_score")
  awayScore      Int?              @map("away_score")
  venue          String
  city           String
  neutralSite    Boolean           @default(false) @map("neutral_site")
  conferenceGame Boolean           @default(false) @map("conference_game")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  bets           Bet[]
  awayTeam       Team              @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeTeam       Team              @relation("HomeTeam", fields: [homeTeamId], references: [id])
  marketLines    MarketLine[]
  matchupOutputs MatchupOutput[]
  teamGameStats  TeamGameStat[]
  weather        Weather?
  injuries       Injury[]
  teamGameAdj    TeamGameAdj[]
  trainingRows   GameTrainingRow[]

  @@index([season, week])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
  @@index([date])
  @@map("games")
}

model TeamGameStat {
  id              String   @id @default(cuid())
  gameId          String   @map("game_id")
  teamId          String   @map("team_id")
  season          Int
  week            Int
  offensive_stats Json
  defensive_stats Json
  special_teams   Json
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  yppOff          Float?   @map("ypp_off")
  successOff      Float?   @map("success_off")
  epaOff          Float?   @map("epa_off")
  pace            Float?
  passYpaOff      Float?   @map("pass_ypa_off")
  rushYpcOff      Float?   @map("rush_ypc_off")
  yppDef          Float?   @map("ypp_def")
  successDef      Float?   @map("success_def")
  epaDef          Float?   @map("epa_def")
  passYpaDef      Float?   @map("pass_ypa_def")
  rushYpcDef      Float?   @map("rush_ypc_def")
  rawJson         Json?    @map("raw_json")
  game            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([gameId, teamId])
  @@unique([gameId, teamId], map: "team_game_stats_game_team_unique")
  @@index([gameId])
  @@index([teamId, season])
  @@index([season, week])
  @@index([gameId], map: "idx_tgs_game")
  @@index([season, week], map: "idx_tgs_season_week")
  @@index([teamId, season], map: "idx_tgs_team_season")
  @@index([teamId, season], map: "team_game_stats_team_season_idx")
  @@map("team_game_stats")
}

model Recruiting {
  id              String   @id @default(cuid())
  teamId          String   @map("team_id")
  season          Int
  class_rank      Int
  avg_rating      Float
  commit_count    Int
  five_stars      Int
  four_stars      Int
  three_stars     Int
  top_players     Json
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  teamTalentIndex Float?   @map("team_talent_index")
  fiveStar        Int?     @default(0) @map("five_star")
  fourStar        Int?     @default(0) @map("four_star")
  threeStar       Int?     @default(0) @map("three_star")
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season], map: "recruiting_team_season_unique")
  @@unique([teamId, season], map: "uniq_recruiting_team_season")
  @@index([season])
  @@index([season], map: "idx_recruiting_season")
  @@index([season, class_rank])
  @@index([teamId, season])
  @@index([teamId], map: "recruiting_team_idx")
  @@map("recruiting")
}

model TeamSeasonTalent {
  season          Int       @map("season")
  teamId          String    @map("team_id")
  talentComposite Float     @map("talent_composite")
  blueChipsPct    Float?    @map("blue_chips_pct")
  fiveStar        Int       @default(0) @map("five_star")
  fourStar        Int       @default(0) @map("four_star")
  threeStar       Int       @default(0) @map("three_star")
  unrated         Int       @default(0)
  sourceUpdatedAt DateTime? @map("source_updated_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  team            Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([season, teamId])
  @@index([season], map: "idx_team_season_talent_season")
  @@index([teamId], map: "idx_team_season_talent_team")
  @@index([season, talentComposite(sort: Desc)], map: "idx_team_season_talent_composite")
  @@map("team_season_talent")
}

model TeamClassCommits {
  season           Int       @map("season")
  teamId           String    @map("team_id")
  commitsTotal     Int       @default(0) @map("commits_total")
  fiveStarCommits  Int       @default(0) @map("five_star_commits")
  fourStarCommits  Int       @default(0) @map("four_star_commits")
  threeStarCommits Int       @default(0) @map("three_star_commits")
  avgCommitRating  Float?    @map("avg_commit_rating")
  classRank        Int?      @map("class_rank")
  sourceUpdatedAt  DateTime? @map("source_updated_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  team             Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([season, teamId])
  @@index([season], map: "idx_team_class_commits_season")
  @@index([teamId], map: "idx_team_class_commits_team")
  @@index([season, classRank], map: "idx_team_class_commits_rank")
  @@map("team_class_commits")
}

model TeamSeasonStat {
  season     Int      @map("season")
  teamId     String   @map("team_id")
  yppOff     Decimal? @map("ypp_off")
  successOff Decimal? @map("success_off")
  passYpaOff Decimal? @map("pass_ypa_off")
  rushYpcOff Decimal? @map("rush_ypc_off")
  paceOff    Decimal? @map("pace_off")
  yppDef     Decimal? @map("ypp_def")
  successDef Decimal? @map("success_def")
  passYpaDef Decimal? @map("pass_ypa_def")
  rushYpcDef Decimal? @map("rush_ypc_def")
  paceDef    Decimal? @map("pace_def")
  epaOff     Decimal? @map("epa_off")
  epaDef     Decimal? @map("epa_def")
  rawJson    Json?    @map("raw_json")
  createdAt  DateTime @default(now()) @map("created_at")

  @@id([season, teamId])
  @@index([season])
  @@index([teamId])
  @@map("team_season_stats")
}

model TeamSeasonRating {
  season        Int      @map("season")
  teamId        String   @map("team_id")
  modelVersion  String   @default("v1") @map("model_version") // Model version (v1, v2, etc.)
  games         Int      @default(0)
  pointsFor     Int?     @map("points_for")
  pointsAgainst Int?     @map("points_against")
  movAvg        Decimal? @map("mov_avg")
  rating        Decimal?
  powerRating   Decimal? @map("power_rating") // Alias for rating, kept for clarity
  offenseRating Decimal? @map("offense_rating")
  defenseRating Decimal? @map("defense_rating")
  sigma         Decimal?
  confidence    Decimal? // 0-1 scale: feature coverage * data_source quality
  dataSource    String?  @map("data_source") // 'game+season', 'season_only', 'baseline'
  // PHASE 2.3: Team-specific HFA
  hfaTeam       Decimal? @map("hfa_team") // Shrunk HFA used in model
  hfaRaw        Decimal? @map("hfa_raw") // Raw HFA before shrinkage
  hfaNHome      Int?     @default(0) @map("hfa_n_home") // Number of home games used
  hfaNAway      Int?     @default(0) @map("hfa_n_away") // Number of away games used
  hfaShrinkW    Decimal? @map("hfa_shrink_w") // Shrinkage weight (0-1)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@id([season, teamId, modelVersion])
  @@index([season])
  @@index([teamId])
  @@index([season, modelVersion])
  @@index([modelVersion])
  @@index([season, rating(sort: Desc)])
  @@index([season, hfaTeam(sort: Desc)], map: "team_season_ratings_hfa_idx")
  @@map("team_season_ratings")
}

model MarketLine {
  id          String   @id @default(cuid())
  gameId      String   @map("game_id")
  season      Int
  week        Int
  lineType    LineType @map("line_type")
  lineValue   Float    @map("line_value")
  timestamp   DateTime
  source      String
  closingLine Float    @map("closing_line")
  bookName    String   @map("book_name")
  teamId      String?  @map("team_id") // The team this line belongs to (for spreads/moneylines)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([gameId, lineType, bookName, timestamp, teamId], map: "market_lines_game_line_book_timestamp_team_unique")
  @@index([gameId, lineType])
  @@index([gameId, lineType, teamId])
  @@index([timestamp])
  @@index([season, week])
  @@index([teamId])
  @@map("market_lines")
}

model PowerRating {
  id           String   @id @default(cuid())
  teamId       String   @map("team_id")
  season       Int
  week         Int
  rating       Float
  modelVersion String   @map("model_version")
  features     Json
  confidence   Float
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season, week, modelVersion], map: "power_ratings_teamId_season_week_modelVersion_key")
  @@index([teamId, season])
  @@index([season, week])
  @@index([modelVersion])
  @@index([rating(sort: Desc)])
  @@map("power_ratings")
}

model MatchupOutput {
  id             String         @id @default(cuid())
  gameId         String         @map("game_id")
  season         Int
  week           Int
  impliedSpread  Float          @map("implied_spread")
  impliedTotal   Float          @map("implied_total")
  marketSpread   Float          @map("market_spread")
  marketTotal    Float          @map("market_total")
  edgeConfidence EdgeConfidence @map("edge_confidence")
  modelVersion   String         @map("model_version")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, modelVersion], map: "matchup_outputs_gameId_modelVersion_key")
  @@index([gameId])
  @@index([season, week])
  @@index([edgeConfidence])
  @@index([modelVersion])
  @@map("matchup_outputs")
}

model Bet {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now()) @map("created_at")
  season      Int
  week        Int
  gameId      String     @map("game_id")
  marketType  BetType    @map("market_type")
  side        BetSide
  modelPrice  Decimal    @map("model_price")
  closePrice  Decimal?   @map("close_price")
  stake       Decimal
  result      BetResult?
  pnl         Decimal?
  clv         Decimal?
  strategyTag String     @map("strategy_tag")
  source      BetSource
  notes       String?
  updatedAt   DateTime   @updatedAt @map("updated_at")
  game        Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([season, week])
  @@index([strategyTag])
  @@index([gameId, marketType])
  @@map("bets")
}

model Ruleset {
  id           String        @id @default(cuid())
  name         String
  description  String?
  parameters   Json
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  strategyRuns StrategyRun[]

  @@index([active])
  @@index([name])
  @@map("rulesets")
}

model StrategyRun {
  id        String   @id @default(cuid())
  rulesetId String   @map("ruleset_id")
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  totalBets Int      @map("total_bets")
  winRate   Float    @map("win_rate")
  roi       Float
  clv       Float
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ruleset   Ruleset  @relation(fields: [rulesetId], references: [id], onDelete: Cascade)

  @@index([rulesetId])
  @@index([startDate])
  @@index([roi(sort: Desc)])
  @@map("strategy_runs")
}

model TeamRanking {
  id              String   @id @default(cuid())
  season          Int
  week            Int
  pollType        PollType @map("poll_type")
  teamId          String   @map("team_id")
  rank            Int // 1-25 for ranked teams
  points          Int? // Poll points (votes) if available
  firstPlaceVotes Int?     @map("first_place_votes")
  source          String   @default("cfbd")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([season, week, pollType, teamId])
  @@index([season, week])
  @@index([teamId])
  @@index([season, week, pollType])
  @@map("team_rankings")
}

enum PollType {
  AP
  COACHES
  CFP
}

enum GameStatus {
  scheduled
  in_progress
  final
}

enum LineType {
  spread
  total
  moneyline
}

enum EdgeConfidence {
  A
  B
  C
}

enum BetType {
  spread
  total
  moneyline
}

enum BetResult {
  win
  loss
  push
}

enum BetSide {
  home
  away
  over
  under
}

enum BetSource {
  strategy_run
  manual
}

model TeamMembership {
  season Int
  teamId String @map("team_id")
  level  String // 'fbs', 'fcs', etc.
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  @@id([season, teamId])
  @@index([season, level])
  @@index([teamId])
  @@map("team_membership")
}

model Weather {
  id                String   @id @default(cuid())
  gameId            String   @unique @map("game_id")
  season            Int
  week              Int
  temperature       Float    @map("temperature") // Fahrenheit
  windSpeed         Float    @map("wind_speed") // mph
  precipitationProb Float    @map("precipitation_prob") // 0-100%
  humidity          Float? // 0-100%
  conditions        String? // "Clear", "Rain", "Snow", etc.
  source            String   @default("visualcrossing") // "visualcrossing", etc.
  forecastTime      DateTime @map("forecast_time") // When the forecast was fetched
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  game              Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([season, week])
  @@index([gameId])
  @@index([forecastTime])
  @@map("weather")
}

model Injury {
  id         String         @id @default(cuid())
  gameId     String         @map("game_id")
  teamId     String         @map("team_id")
  season     Int
  week       Int
  playerName String?        @map("player_name") // Optional: player name if available
  position   String         @map("position") // QB, OL, DL, WR, RB, DB, etc.
  severity   InjurySeverity @map("severity") // 'out', 'questionable', 'probable'
  bodyPart   String?        @map("body_part") // Optional: "knee", "shoulder", etc.
  injuryType String?        @map("injury_type") // Optional: "ACL", "concussion", etc.
  status     String? // Optional: additional status text
  source     String         @default("manual") // "manual", "cfbd", "espn", etc.
  reportedAt DateTime?      @map("reported_at") // When injury was reported
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  game       Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team       Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([teamId, season])
  @@index([season, week])
  @@index([position])
  @@index([severity])
  @@map("injuries")
}

enum InjurySeverity {
  OUT // Player will not play
  QUESTIONABLE // Player may or may not play
  PROBABLE // Player is likely to play
  DOUBTFUL // Player unlikely to play
}

// ============================================================================
// CFBD FEATURE TABLES (Phase 3)
// ============================================================================

model CfbdTeamMap {
  teamIdInternal  String   @id @map("team_id_internal")
  teamNameCfbd    String   @map("team_name_cfbd")
  seasonFirstSeen Int?     @map("season_first_seen")
  seasonLastSeen  Int?     @map("season_last_seen")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([teamNameCfbd])
  @@map("cfbd_team_map")
}

model CfbdGame {
  gameIdCfbd         String   @id @map("game_id_cfbd")
  season             Int
  week               Int
  date               DateTime
  homeTeamIdInternal String   @map("home_team_id_internal")
  awayTeamIdInternal String   @map("away_team_id_internal")
  neutralSite        Boolean  @default(false) @map("neutral_site")
  venue              String?
  homeConference     String?  @map("home_conference")
  awayConference     String?  @map("away_conference")
  source             String   @default("cfbd")
  ingestedAt         DateTime @default(now()) @map("ingested_at")
  asOf               DateTime @default(now()) @map("as_of")
  versionTag         String?  @map("version_tag")

  @@index([season, week])
  @@index([homeTeamIdInternal])
  @@index([awayTeamIdInternal])
  @@map("cfbd_games")
}

model CfbdEffTeamGame {
  gameIdCfbd       String   @map("game_id_cfbd")
  teamIdInternal   String   @map("team_id_internal")
  // Offense
  offEpa           Decimal? @map("off_epa")
  offSr            Decimal? @map("off_sr")
  isoPppOff        Decimal? @map("iso_ppp_off")
  ppoOff           Decimal? @map("ppo_off")
  lineYardsOff     Decimal? @map("line_yards_off")
  havocOff         Decimal? @map("havoc_off")
  havocFront7Off   Decimal? @map("havoc_front7_off")
  havocDbOff       Decimal? @map("havoc_db_off")
  // Defense
  defEpa           Decimal? @map("def_epa")
  defSr            Decimal? @map("def_sr")
  isoPppDef        Decimal? @map("iso_ppp_def")
  ppoDef           Decimal? @map("ppo_def")
  stuffRate        Decimal? @map("stuff_rate")
  powerSuccess     Decimal? @map("power_success")
  havocDef         Decimal? @map("havoc_def")
  havocFront7Def   Decimal? @map("havoc_front7_def")
  havocDbDef       Decimal? @map("havoc_db_def")
  // Splits
  runEpa           Decimal? @map("run_epa")
  passEpa          Decimal? @map("pass_epa")
  runSr            Decimal? @map("run_sr")
  passSr           Decimal? @map("pass_sr")
  // Phase (early/late downs)
  earlyDownEpa     Decimal? @map("early_down_epa")
  lateDownEpa      Decimal? @map("late_down_epa")
  // Field position
  avgFieldPosition Decimal? @map("avg_field_position")
  // Metadata
  source           String   @default("cfbd")
  ingestedAt       DateTime @default(now()) @map("ingested_at")
  asOf             DateTime @default(now()) @map("as_of")
  versionTag       String?  @map("version_tag")

  @@id([gameIdCfbd, teamIdInternal])
  @@index([gameIdCfbd])
  @@index([teamIdInternal])
  @@map("cfbd_eff_team_game")
}

model CfbdEffTeamSeason {
  season           Int
  teamIdInternal   String   @map("team_id_internal")
  // Same fields as game-level
  offEpa           Decimal? @map("off_epa")
  offSr            Decimal? @map("off_sr")
  isoPppOff        Decimal? @map("iso_ppp_off")
  ppoOff           Decimal? @map("ppo_off")
  lineYardsOff     Decimal? @map("line_yards_off")
  havocOff         Decimal? @map("havoc_off")
  havocFront7Off   Decimal? @map("havoc_front7_off")
  havocDbOff       Decimal? @map("havoc_db_off")
  defEpa           Decimal? @map("def_epa")
  defSr            Decimal? @map("def_sr")
  isoPppDef        Decimal? @map("iso_ppp_def")
  ppoDef           Decimal? @map("ppo_def")
  stuffRate        Decimal? @map("stuff_rate")
  powerSuccess     Decimal? @map("power_success")
  havocDef         Decimal? @map("havoc_def")
  havocFront7Def   Decimal? @map("havoc_front7_def")
  havocDbDef       Decimal? @map("havoc_db_def")
  runEpa           Decimal? @map("run_epa")
  passEpa          Decimal? @map("pass_epa")
  runSr            Decimal? @map("run_sr")
  passSr           Decimal? @map("pass_sr")
  earlyDownEpa     Decimal? @map("early_down_epa")
  lateDownEpa      Decimal? @map("late_down_epa")
  avgFieldPosition Decimal? @map("avg_field_position")
  source           String   @default("cfbd")
  ingestedAt       DateTime @default(now()) @map("ingested_at")
  asOf             DateTime @default(now()) @map("as_of")
  versionTag       String?  @map("version_tag")

  @@id([season, teamIdInternal])
  @@index([teamIdInternal])
  @@map("cfbd_eff_team_season")
}

model CfbdPpaTeamGame {
  gameIdCfbd     String   @map("game_id_cfbd")
  teamIdInternal String   @map("team_id_internal")
  ppaOffense     Decimal? @map("ppa_offense")
  ppaDefense     Decimal? @map("ppa_defense")
  ppaOverall     Decimal? @map("ppa_overall")
  source         String   @default("cfbd")
  ingestedAt     DateTime @default(now()) @map("ingested_at")
  asOf           DateTime @default(now()) @map("as_of")
  versionTag     String?  @map("version_tag")

  @@id([gameIdCfbd, teamIdInternal])
  @@index([gameIdCfbd])
  @@index([teamIdInternal])
  @@map("cfbd_ppa_team_game")
}

model CfbdPpaTeamSeason {
  season         Int
  teamIdInternal String   @map("team_id_internal")
  ppaOffense     Decimal? @map("ppa_offense")
  ppaDefense     Decimal? @map("ppa_defense")
  ppaOverall     Decimal? @map("ppa_overall")
  source         String   @default("cfbd")
  ingestedAt     DateTime @default(now()) @map("ingested_at")
  asOf           DateTime @default(now()) @map("as_of")
  versionTag     String?  @map("version_tag")

  @@id([season, teamIdInternal])
  @@index([teamIdInternal])
  @@map("cfbd_ppa_team_season")
}

model CfbdDrivesTeamGame {
  gameIdCfbd          String   @map("game_id_cfbd")
  teamIdInternal      String   @map("team_id_internal")
  playsPerMinute      Decimal? @map("plays_per_minute")
  secondsPerSnap      Decimal? @map("seconds_per_snap")
  scoringOppsPerDrive Decimal? @map("scoring_opps_per_drive")
  pointsPerScoringOpp Decimal? @map("points_per_scoring_opp")
  avgStartPos         Decimal? @map("avg_start_pos")
  redzoneTrips        Int?     @map("redzone_trips")
  source              String   @default("cfbd")
  ingestedAt          DateTime @default(now()) @map("ingested_at")
  asOf                DateTime @default(now()) @map("as_of")
  versionTag          String?  @map("version_tag")

  @@id([gameIdCfbd, teamIdInternal])
  @@index([gameIdCfbd])
  @@index([teamIdInternal])
  @@map("cfbd_drives_team_game")
}

model CfbdPriorsTeamSeason {
  season           Int
  teamIdInternal   String   @map("team_id_internal")
  talent247        Decimal? @map("talent_247")
  returningProdOff Decimal? @map("returning_prod_off")
  returningProdDef Decimal? @map("returning_prod_def")
  source           String   @default("cfbd")
  ingestedAt       DateTime @default(now()) @map("ingested_at")
  asOf             DateTime @default(now()) @map("as_of")
  versionTag       String?  @map("version_tag")

  @@id([season, teamIdInternal])
  @@index([teamIdInternal])
  @@map("cfbd_priors_team_season")
}

model CfbdWeatherGame {
  gameIdCfbd  String   @id @map("game_id_cfbd")
  temperature Decimal?
  windSpeed   Decimal? @map("wind_speed")
  precipProb  Decimal? @map("precip_prob")
  source      String   @default("cfbd")
  ingestedAt  DateTime @default(now()) @map("ingested_at")
  asOf        DateTime @default(now()) @map("as_of")
  versionTag  String?  @map("version_tag")

  @@index([gameIdCfbd])
  @@map("cfbd_weather_game")
}

model TeamGameAdj {
  // Primary keys
  gameId         String @map("game_id")
  teamId         String @map("team_id")
  season         Int
  week           Int
  featureVersion String @map("feature_version")

  // Opponent-adjusted nets (Offense vs Opponent Defense)
  offAdjEpa           Decimal? @map("off_adj_epa")
  offAdjSr            Decimal? @map("off_adj_sr")
  offAdjExplosiveness Decimal? @map("off_adj_explosiveness")
  offAdjPpa           Decimal? @map("off_adj_ppa")
  offAdjHavoc         Decimal? @map("off_adj_havoc")
  offAdjHavocFront7   Decimal? @map("off_adj_havoc_front7")
  offAdjHavocDb       Decimal? @map("off_adj_havoc_db")

  // Opponent-adjusted nets (Defense vs Opponent Offense)
  defAdjEpa           Decimal? @map("def_adj_epa")
  defAdjSr            Decimal? @map("def_adj_sr")
  defAdjExplosiveness Decimal? @map("def_adj_explosiveness")
  defAdjPpa           Decimal? @map("def_adj_ppa")
  defAdjHavoc         Decimal? @map("def_adj_havoc")
  defAdjHavocFront7   Decimal? @map("def_adj_havoc_front7")
  defAdjHavocDb       Decimal? @map("def_adj_havoc_db")

  // Matchup edges (off_adj - def_adj)
  edgeEpa           Decimal? @map("edge_epa")
  edgeSr            Decimal? @map("edge_sr")
  edgeExplosiveness Decimal? @map("edge_explosiveness")
  edgePpa           Decimal? @map("edge_ppa")
  edgeHavoc         Decimal? @map("edge_havoc")
  edgeHavocFront7   Decimal? @map("edge_havoc_front7")
  edgeHavocDb       Decimal? @map("edge_havoc_db")

  // Recency EWMAs (3-game)
  ewma3Epa           Decimal? @map("ewma3_epa")
  ewma3Sr            Decimal? @map("ewma3_sr")
  ewma3Explosiveness Decimal? @map("ewma3_explosiveness")
  ewma3Ppa           Decimal? @map("ewma3_ppa")
  ewma3OffAdjEpa     Decimal? @map("ewma3_off_adj_epa")
  ewma3DefAdjEpa     Decimal? @map("ewma3_def_adj_epa")

  // Recency EWMAs (5-game)
  ewma5Epa           Decimal? @map("ewma5_epa")
  ewma5Sr            Decimal? @map("ewma5_sr")
  ewma5Explosiveness Decimal? @map("ewma5_explosiveness")
  ewma5Ppa           Decimal? @map("ewma5_ppa")
  ewma5OffAdjEpa     Decimal? @map("ewma5_off_adj_epa")
  ewma5DefAdjEpa     Decimal? @map("ewma5_def_adj_epa")

  // Low sample flag
  lowSample3g Boolean @default(false) @map("low_sample_3g")
  lowSample5g Boolean @default(false) @map("low_sample_5g")

  // Pace & finishing (placeholders - NULL until drives ingested)
  secPerPlay          Decimal? @map("sec_per_play")
  playsPerGame        Decimal? @map("plays_per_game")
  ptsPerScoringOpp    Decimal? @map("pts_per_scoring_opp")
  scoringOppsPerDrive Decimal? @map("scoring_opps_per_drive")
  avgStartPos         Decimal? @map("avg_start_pos")

  // Priors as direct features
  talent247        Decimal? @map("talent_247")
  returningProdOff Decimal? @map("returning_prod_off")
  returningProdDef Decimal? @map("returning_prod_def")

  // Context flags
  neutralSite    Boolean @default(false) @map("neutral_site")
  conferenceGame Boolean @default(false) @map("conference_game")
  restDelta      Int?    @map("rest_delta")
  byeWeek        Boolean @default(false) @map("bye_week")
  isHome         Boolean @default(false) @map("is_home")
  isFbs          Boolean @default(true) @map("is_fbs")
  p5Flag         Boolean @default(false) @map("p5_flag")
  g5Flag         Boolean @default(false) @map("g5_flag")
  fcsFlag        Boolean @default(false) @map("fcs_flag")

  // Metadata
  sourceSnapshot String?  @map("source_snapshot")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([gameId, teamId, featureVersion])
  @@index([gameId])
  @@index([teamId, season, week])
  @@index([season, week])
  @@index([featureVersion])
  @@map("team_game_adj")
}

model GameTrainingRow {
  // Primary keys
  gameId         String @map("game_id")
  featureVersion String @map("feature_version")

  // Meta
  season     Int
  week       Int
  homeTeamId String   @map("home_team_id")
  awayTeamId String   @map("away_team_id")
  setLabel   String?  @map("set_label") // 'A', 'B', 'C'
  rowWeight  Decimal? @default(1.0) @map("row_weight")

  // Target (home-minus-away consensus pre-kick)
  targetSpreadHma Decimal?  @map("target_spread_hma")
  booksSpread     Int?      @map("books_spread")
  windowStart     DateTime? @map("window_start")
  windowEnd       DateTime? @map("window_end")
  usedPreKick     Boolean   @default(true) @map("used_pre_kick")

  // Core diffs (home - away)
  ratingDiffV2    Decimal? @map("rating_diff_v2")
  hfaPoints       Decimal? @map("hfa_points")
  offAdjSrDiff    Decimal? @map("off_adj_sr_diff")
  offAdjExplDiff  Decimal? @map("off_adj_expl_diff")
  offAdjPpaDiff   Decimal? @map("off_adj_ppa_diff")
  havocFront7Diff Decimal? @map("havoc_front7_diff")
  havocDbDiff     Decimal? @map("havoc_db_diff")

  // EWMA diffs
  ewma3OffAdjPpaDiff Decimal? @map("ewma3_off_adj_ppa_diff")
  ewma5OffAdjPpaDiff Decimal? @map("ewma5_off_adj_ppa_diff")
  ewma3OffAdjSrDiff  Decimal? @map("ewma3_off_adj_sr_diff")
  ewma5OffAdjSrDiff  Decimal? @map("ewma5_off_adj_sr_diff")

  // Context
  neutralSite   Boolean @default(false) @map("neutral_site")
  restDeltaDiff Int?    @map("rest_delta_diff")
  byeHome       Boolean @default(false) @map("bye_home")
  byeAway       Boolean @default(false) @map("bye_away")
  sameConf      Boolean @default(false) @map("same_conf")
  tierGap       Int?    @map("tier_gap")
  p5VsG5        Boolean @default(false) @map("p5_vs_g5")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  game     Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  homeTeam Team @relation("HomeTrainingRows", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeam Team @relation("AwayTrainingRows", fields: [awayTeamId], references: [id], onDelete: Cascade)

  @@id([gameId, featureVersion])
  @@index([season, week, featureVersion])
  @@index([setLabel])
  @@index([featureVersion])
  @@map("game_training_rows")
}

model ModelCalibration {
  id             String @id @default(cuid())
  modelVersion   String @map("model_version") // 'cal_v1', 'cal_v2', etc.
  fitLabel       String @map("fit_label") // 'core', 'extended'
  season         Int
  featureVersion String @map("feature_version") // 'fe_v1', etc.

  // Hyperparameters
  bestAlpha         Decimal? @map("best_alpha") // Elastic Net alpha (λ)
  bestL1Ratio       Decimal? @map("best_l1_ratio") // Elastic Net l1_ratio
  gridSearchResults Json?    @map("grid_search_results") // Full grid results

  // Coefficients (standardized + original scale)
  coefficients Json // { feature: { standardized: number, original: number } }
  intercept    Decimal // Intercept (original scale)
  scalerParams Json    @map("scaler_params") // { feature: { mean: number, std: number } }

  // Metrics (train + walk-forward)
  trainRmse           Decimal? @map("train_rmse")
  trainR2             Decimal? @map("train_r2")
  trainPearson        Decimal? @map("train_pearson")
  trainSpearman       Decimal? @map("train_spearman")
  walkForwardRmse     Decimal? @map("walk_forward_rmse")
  walkForwardR2       Decimal? @map("walk_forward_r2")
  walkForwardPearson  Decimal? @map("walk_forward_pearson")
  walkForwardSpearman Decimal? @map("walk_forward_spearman")

  // Gates
  slope         Decimal? // OLS slope (ŷ vs market) on hold-out
  signAgreement Decimal? @map("sign_agreement") // % sign agreement
  gatesPassed   Boolean  @default(false) @map("gates_passed")
  gateDetails   Json?    @map("gate_details") // Detailed gate results

  // Residual diagnostics
  residualSummary Json? @map("residual_summary") // Global + bucket means
  topOutliers     Json? @map("top_outliers") // Top 20 outliers

  // Training data snapshot
  trainingRowIds String[] @map("training_row_ids") // IDs or game_ids used
  setLabels      String[] @map("set_labels") // ['A', 'B']

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([modelVersion, fitLabel])
  @@index([modelVersion])
  @@index([gatesPassed])
  @@index([season])
  @@map("model_calibration")
}
