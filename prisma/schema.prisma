generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Team {
  id             String         @id
  name           String
  conference     String
  division       String?
  logoUrl        String?        @map("logo_url")
  primaryColor   String?        @map("primary_color")
  secondaryColor String?        @map("secondary_color")
  mascot         String?
  city           String?
  state          String?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  awayGames      Game[]         @relation("AwayTeam")
  homeGames      Game[]         @relation("HomeTeam")
  powerRatings   PowerRating[]
  recruiting     Recruiting[]
  teamGameStats  TeamGameStat[]

  @@index([conference, division])
  @@index([name])
  @@map("teams")
}

model Game {
  id             String          @id
  homeTeamId     String          @map("home_team_id")
  awayTeamId     String          @map("away_team_id")
  season         Int
  week           Int
  date           DateTime
  status         GameStatus
  homeScore      Int?            @map("home_score")
  awayScore      Int?            @map("away_score")
  venue          String
  city           String
  neutralSite    Boolean         @default(false) @map("neutral_site")
  conferenceGame Boolean         @default(false) @map("conference_game")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  bets           Bet[]
  awayTeam       Team            @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeTeam       Team            @relation("HomeTeam", fields: [homeTeamId], references: [id])
  marketLines    MarketLine[]
  matchupOutputs MatchupOutput[]
  teamGameStats  TeamGameStat[]

  @@index([season, week])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
  @@index([date])
  @@map("games")
}

model TeamGameStat {
  id              String   @id @default(cuid())
  gameId          String   @map("game_id")
  teamId          String   @map("team_id")
  season          Int
  week            Int
  offensive_stats Json
  defensive_stats Json
  special_teams   Json
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  yppOff          Float?   @map("ypp_off")
  successOff      Float?   @map("success_off")
  epaOff          Float?   @map("epa_off")
  pace            Float?
  passYpaOff      Float?   @map("pass_ypa_off")
  rushYpcOff      Float?   @map("rush_ypc_off")
  yppDef          Float?   @map("ypp_def")
  successDef      Float?   @map("success_def")
  epaDef          Float?   @map("epa_def")
  passYpaDef      Float?   @map("pass_ypa_def")
  rushYpcDef      Float?   @map("rush_ypc_def")
  rawJson         Json?    @map("raw_json")
  game            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([gameId, teamId])
  @@unique([gameId, teamId], map: "team_game_stats_game_team_unique")
  @@index([gameId])
  @@index([teamId, season])
  @@index([season, week])
  @@index([gameId], map: "idx_tgs_game")
  @@index([season, week], map: "idx_tgs_season_week")
  @@index([teamId, season], map: "idx_tgs_team_season")
  @@index([teamId, season], map: "team_game_stats_team_season_idx")
  @@map("team_game_stats")
}

model Recruiting {
  id              String   @id @default(cuid())
  teamId          String   @map("team_id")
  season          Int
  class_rank      Int
  avg_rating      Float
  commit_count    Int
  five_stars      Int
  four_stars      Int
  three_stars     Int
  top_players     Json
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  teamTalentIndex Float?   @map("team_talent_index")
  fiveStar        Int?     @default(0) @map("five_star")
  fourStar        Int?     @default(0) @map("four_star")
  threeStar       Int?     @default(0) @map("three_star")
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season], map: "recruiting_team_season_unique")
  @@unique([teamId, season], map: "uniq_recruiting_team_season")
  @@index([season])
  @@index([season], map: "idx_recruiting_season")
  @@index([season, class_rank])
  @@index([teamId, season])
  @@index([teamId], map: "recruiting_team_idx")
  @@map("recruiting")
}

model TeamSeasonStat {
  season     Int      @map("season")
  teamId     String   @map("team_id")
  yppOff     Decimal? @map("ypp_off")
  successOff Decimal? @map("success_off")
  passYpaOff Decimal? @map("pass_ypa_off")
  rushYpcOff Decimal? @map("rush_ypc_off")
  paceOff    Decimal? @map("pace_off")
  yppDef     Decimal? @map("ypp_def")
  successDef Decimal? @map("success_def")
  passYpaDef Decimal? @map("pass_ypa_def")
  rushYpcDef Decimal? @map("rush_ypc_def")
  paceDef    Decimal? @map("pace_def")
  epaOff     Decimal? @map("epa_off")
  epaDef     Decimal? @map("epa_def")
  rawJson    Json?    @map("raw_json")
  createdAt  DateTime @default(now()) @map("created_at")

  @@id([season, teamId])
  @@index([season])
  @@index([teamId])
  @@map("team_season_stats")
}

model MarketLine {
  id          String   @id @default(cuid())
  gameId      String   @map("game_id")
  season      Int
  week        Int
  lineType    LineType @map("line_type")
  lineValue   Float    @map("line_value")
  timestamp   DateTime
  source      String
  closingLine Float    @map("closing_line")
  bookName    String   @map("book_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, lineType, bookName, timestamp], map: "market_lines_game_line_book_timestamp_unique")
  @@index([gameId, lineType])
  @@index([timestamp])
  @@index([season, week])
  @@map("market_lines")
}

model PowerRating {
  id           String   @id @default(cuid())
  teamId       String   @map("team_id")
  season       Int
  week         Int
  rating       Float
  modelVersion String   @map("model_version")
  features     Json
  confidence   Float
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season, week, modelVersion], map: "power_ratings_teamId_season_week_modelVersion_key")
  @@index([teamId, season])
  @@index([season, week])
  @@index([modelVersion])
  @@index([rating(sort: Desc)])
  @@map("power_ratings")
}

model MatchupOutput {
  id             String         @id @default(cuid())
  gameId         String         @map("game_id")
  season         Int
  week           Int
  impliedSpread  Float          @map("implied_spread")
  impliedTotal   Float          @map("implied_total")
  marketSpread   Float          @map("market_spread")
  marketTotal    Float          @map("market_total")
  edgeConfidence EdgeConfidence @map("edge_confidence")
  modelVersion   String         @map("model_version")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, modelVersion], map: "matchup_outputs_gameId_modelVersion_key")
  @@index([gameId])
  @@index([season, week])
  @@index([edgeConfidence])
  @@index([modelVersion])
  @@map("matchup_outputs")
}

model Bet {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now()) @map("created_at")
  season      Int
  week        Int
  gameId      String     @map("game_id")
  marketType  BetType    @map("market_type")
  side        BetSide
  modelPrice  Decimal    @map("model_price")
  closePrice  Decimal?   @map("close_price")
  stake       Decimal
  result      BetResult?
  pnl         Decimal?
  clv         Decimal?
  strategyTag String     @map("strategy_tag")
  source      BetSource
  notes       String?
  updatedAt   DateTime   @updatedAt @map("updated_at")
  game        Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([season, week])
  @@index([strategyTag])
  @@index([gameId, marketType])
  @@map("bets")
}

model Ruleset {
  id           String        @id @default(cuid())
  name         String
  description  String?
  parameters   Json
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  strategyRuns StrategyRun[]

  @@index([active])
  @@index([name])
  @@map("rulesets")
}

model StrategyRun {
  id        String   @id @default(cuid())
  rulesetId String   @map("ruleset_id")
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  totalBets Int      @map("total_bets")
  winRate   Float    @map("win_rate")
  roi       Float
  clv       Float
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ruleset   Ruleset  @relation(fields: [rulesetId], references: [id], onDelete: Cascade)

  @@index([rulesetId])
  @@index([startDate])
  @@index([roi(sort: Desc)])
  @@map("strategy_runs")
}

enum GameStatus {
  scheduled
  in_progress
  final
}

enum LineType {
  spread
  total
  moneyline
}

enum EdgeConfidence {
  A
  B
  C
}

enum BetType {
  spread
  total
  moneyline
}

enum BetResult {
  win
  loss
  push
}

enum BetSide {
  home
  away
  over
  under
}

enum BetSource {
  strategy_run
  manual
}
