// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // pooled (pgBouncer) for runtime
  directUrl = env("DIRECT_URL") // direct for migrations
}

// =============================================================================
// Core Tables
// =============================================================================

model Team {
  id             String   @id
  name           String
  conference     String
  division       String?
  logoUrl        String?  @map("logo_url")
  primaryColor   String?  @map("primary_color")
  secondaryColor String?  @map("secondary_color")
  mascot         String?
  city           String?
  state          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  homeGames     Game[]         @relation("HomeTeam")
  awayGames     Game[]         @relation("AwayTeam")
  teamGameStats TeamGameStat[]
  recruiting    Recruiting[]
  powerRatings  PowerRating[]

  @@index([conference, division])
  @@index([name])
  @@map("teams")
}

model Game {
  id             String     @id
  homeTeamId     String     @map("home_team_id")
  awayTeamId     String     @map("away_team_id")
  season         Int
  week           Int
  date           DateTime
  status         GameStatus
  homeScore      Int?       @map("home_score")
  awayScore      Int?       @map("away_score")
  venue          String
  city           String
  neutralSite    Boolean    @default(false) @map("neutral_site")
  conferenceGame Boolean    @default(false) @map("conference_game")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  homeTeam       Team            @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam       Team            @relation("AwayTeam", fields: [awayTeamId], references: [id])
  teamGameStats  TeamGameStat[]
  marketLines    MarketLine[]
  matchupOutputs MatchupOutput[]
  bets           Bet[]

  @@index([season, week])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
  @@index([date])
  @@map("games")
}

model TeamGameStat {
  id            String   @id @default(cuid())
  gameId        String   @map("game_id")
  teamId        String   @map("team_id")
  season        Int
  week          Int
  opponentId    String?  @map("opponent_id")
  isHome        Boolean? @map("is_home") @default(false)
  
  // Core features (nullable until data available)
  playsOff      Int?     @map("plays_off")
  yardsOff      Int?     @map("yards_off")
  yppOff        Float?   @map("ypp_off")
  successOff    Float?   @map("success_off")
  epaOff        Float?   @map("epa_off")
  pacePlaysGm   Float?   @map("pace_plays_gm") // plays per game proxy
  
  passYardsOff  Int?     @map("pass_yards_off")
  rushYardsOff  Int?     @map("rush_yards_off")
  passAttOff    Int?     @map("pass_att_off")
  rushAttOff    Int?     @map("rush_att_off")
  passYpaOff    Float?   @map("pass_ypa_off")
  rushYpcOff    Float?   @map("rush_ypc_off")
  
  // Defense mirrors (nullable if unavailable)
  playsDef      Int?     @map("plays_def")
  yardsDef      Int?     @map("yards_def")
  yppDef        Float?   @map("ypp_def")
  successDef    Float?   @map("success_def")
  epaDef        Float?   @map("epa_def")
  passYardsDef  Int?     @map("pass_yards_def")
  rushYardsDef  Int?     @map("rush_yards_def")
  passAttDef    Int?     @map("pass_att_def")
  rushAttDef    Int?     @map("rush_att_def")
  passYpaDef    Float?   @map("pass_ypa_def")
  rushYpcDef    Float?   @map("rush_ypc_def")
  
  rawJson       Json?    @map("raw_json")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([teamId, season])
  @@index([season, week])
  @@map("team_game_stats")
}

model Recruiting {
  id                 String   @id @default(cuid())
  teamId             String   @map("team_id")
  season             Int
  teamTalentIndex    Float?   @map("team_talent_index") // CFBD "team talent" composite
  fiveStar           Int?     @map("five_star")
  fourStar           Int?     @map("four_star")
  threeStar          Int?     @map("three_star")
  commits            Int?
  points             Float?
  nationalRank       Int?     @map("national_rank")
  conferenceRank     Int?     @map("conference_rank")
  rawJson            Json?    @map("raw_json")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season])
  @@index([season])
  @@map("recruiting")
}

model MarketLine {
  id          String   @id @default(cuid())
  gameId      String   @map("game_id")
  season      Int
  week        Int
  lineType    LineType @map("line_type")
  lineValue   Float    @map("line_value")
  timestamp   DateTime
  source      String
  closingLine Float    @map("closing_line")
  bookName    String   @map("book_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, lineType, bookName, timestamp])
  @@index([gameId, lineType])
  @@index([timestamp])
  @@index([season, week])
  @@map("market_lines")
}

model PowerRating {
  id           String   @id @default(cuid())
  teamId       String   @map("team_id")
  season       Int
  week         Int
  rating       Float
  modelVersion String   @map("model_version")
  features     Json
  confidence   Float
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, season, week, modelVersion]) // <-- needed for upsert
  // Indexes & constraints
  @@index([teamId, season])
  @@index([season, week])
  @@index([modelVersion])
  @@index([rating(sort: Desc)])
  @@map("power_ratings")
}

model MatchupOutput {
  id             String         @id @default(cuid())
  gameId         String         @map("game_id")
  season         Int
  week           Int
  impliedSpread  Float          @map("implied_spread")
  impliedTotal   Float          @map("implied_total")
  marketSpread   Float          @map("market_spread")
  marketTotal    Float          @map("market_total")
  edgeConfidence EdgeConfidence @map("edge_confidence")
  modelVersion   String         @map("model_version")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, modelVersion])
  @@index([gameId])
  @@index([season, week])
  @@index([edgeConfidence])
  @@index([modelVersion])
  @@map("matchup_outputs")
}

model Bet {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now()) @map("created_at")
  season       Int
  week         Int
  gameId       String     @map("game_id")
  marketType   BetType    @map("market_type")
  side         BetSide
  modelPrice   Decimal    @map("model_price")
  closePrice   Decimal?   @map("close_price")
  stake        Decimal
  result       BetResult?
  pnl          Decimal?
  clv          Decimal?
  strategyTag  String     @map("strategy_tag")
  source       BetSource
  notes        String?
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([season, week])
  @@index([strategyTag])
  @@index([gameId, marketType])
  @@map("bets")
}

model Ruleset {
  id          String   @id @default(cuid())
  name        String
  description String?
  parameters  Json
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  strategyRuns StrategyRun[]

  @@index([active])
  @@index([name])
  @@map("rulesets")
}

model StrategyRun {
  id        String   @id @default(cuid())
  rulesetId String   @map("ruleset_id")
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  totalBets Int      @map("total_bets")
  winRate   Float    @map("win_rate")
  roi       Float
  clv       Float
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ruleset Ruleset @relation(fields: [rulesetId], references: [id], onDelete: Cascade)

  @@index([rulesetId])
  @@index([startDate])
  @@index([roi(sort: Desc)])
  @@map("strategy_runs")
}


// =============================================================================
// Enums
// =============================================================================

enum GameStatus {
  scheduled
  in_progress
  final
}

enum LineType {
  spread
  total
  moneyline
}

enum EdgeConfidence {
  A
  B
  C
}

enum BetType {
  spread
  total
  moneyline
}

enum BetResult {
  win
  loss
  push
}

enum BetSide {
  home
  away
  over
  under
}

enum BetSource {
  strategy_run
  manual
}
