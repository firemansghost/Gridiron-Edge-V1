name: Prisma Schema Guardrails

on:
  pull_request:
    paths:
      - 'prisma/**'
      - '.github/workflows/prisma-guardrails.yml'

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to compare changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Prisma CLI
        run: npm install -g prisma@6.17.0

      - name: Format schema
        id: format
        run: |
          echo "üîç Checking Prisma schema formatting..."
          prisma format --schema=prisma/schema.prisma
          
          # Check if formatting changed anything
          if git diff --exit-code prisma/schema.prisma; then
            echo "‚úÖ Schema is properly formatted"
            echo "formatted=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Schema formatting changes detected"
            echo "formatted=true" >> $GITHUB_OUTPUT
          fi

      - name: Fail if formatting needed
        if: steps.format.outputs.formatted == 'true'
        run: |
          echo "============================================"
          echo "‚ùå PRISMA SCHEMA NOT FORMATTED"
          echo "============================================"
          echo ""
          echo "The schema file needs formatting."
          echo ""
          echo "To fix:"
          echo "  npx prisma format --schema=prisma/schema.prisma"
          echo "  git add prisma/schema.prisma"
          echo "  git commit --amend --no-edit"
          echo "  git push --force-with-lease"
          echo ""
          echo "============================================"
          exit 1

      - name: Validate schema
        run: |
          echo "üîç Validating Prisma schema..."
          prisma validate --schema=prisma/schema.prisma
          echo "‚úÖ Schema is valid"

      - name: Check for schema changes without migration
        id: check_migration
        run: |
          echo "üîç Checking if schema changes have corresponding migrations..."
          
          # Check if schema.prisma changed in this PR
          git fetch origin ${{ github.base_ref }}
          SCHEMA_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -c "prisma/schema.prisma" || echo "0")
          
          # Check if any migrations were added/modified in this PR
          MIGRATIONS_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -c "prisma/migrations/" || echo "0")
          
          echo "Schema changed: $SCHEMA_CHANGED"
          echo "Migrations changed: $MIGRATIONS_CHANGED"
          
          if [ "$SCHEMA_CHANGED" -gt 0 ] && [ "$MIGRATIONS_CHANGED" -eq 0 ]; then
            echo "missing_migration=true" >> $GITHUB_OUTPUT
          else
            echo "missing_migration=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if migration missing
        if: steps.check_migration.outputs.missing_migration == 'true'
        run: |
          echo "============================================"
          echo "‚ùå SCHEMA CHANGED WITHOUT MIGRATION"
          echo "============================================"
          echo ""
          echo "You modified prisma/schema.prisma but did not"
          echo "add a corresponding migration."
          echo ""
          echo "This usually means you need to:"
          echo "  1. Create a migration for your schema changes:"
          echo "     npx prisma migrate dev --name <describe_your_change>"
          echo ""
          echo "  2. Commit the new migration files:"
          echo "     git add prisma/migrations/"
          echo "     git commit -m 'Add migration: <describe_your_change>'"
          echo ""
          echo "  3. Push your changes:"
          echo "     git push"
          echo ""
          echo "Examples:"
          echo "  npx prisma migrate dev --name add_user_email"
          echo "  npx prisma migrate dev --name make_logo_optional"
          echo "  npx prisma migrate dev --name add_team_index"
          echo ""
          echo "Note: If you only changed comments or formatting,"
          echo "you can skip this check by adding a migration that"
          echo "generates no SQL changes."
          echo ""
          echo "============================================"
          exit 1

      - name: Success summary
        if: success()
        run: |
          echo "============================================"
          echo "‚úÖ PRISMA SCHEMA GUARDRAILS PASSED"
          echo "============================================"
          echo ""
          echo "‚úÖ Schema is properly formatted"
          echo "‚úÖ Schema validation passed"
          echo "‚úÖ Schema changes have corresponding migrations"
          echo ""
          echo "============================================"

