name: Grade Bets

on:
  schedule:
    # Hourly on Saturday and Sunday
    - cron: '0 * * * 6,0'
    # Nightly otherwise at 3:00 UTC
    - cron: '0 3 * * 1-5'
  workflow_dispatch:
    inputs:
      season:
        description: 'Season to grade (optional)'
        required: false
        type: string
      week:
        description: 'Week to grade (optional)'
        required: false
        type: string
      force:
        description: 'Force regrade existing bets'
        required: false
        type: boolean
        default: false

concurrency:
  group: grade-bets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  grade:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL:   ${{ secrets.DIRECT_URL }}
      TZ: America/Chicago
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - run: npm run prisma:generate
      - run: npm run build:jobs
      - name: Grade Bets
        run: |
          echo "ðŸ§® Grading bets..."
          ARGS=""
          if [ "${{ github.event.inputs.season }}" != "" ]; then
            ARGS="$ARGS --season ${{ github.event.inputs.season }}"
          fi
          if [ "${{ github.event.inputs.week }}" != "" ]; then
            ARGS="$ARGS --week ${{ github.event.inputs.week }}"
          fi
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi
          npm run grade:bets -- $ARGS
          echo "âœ… Grading completed"


