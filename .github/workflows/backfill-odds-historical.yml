name: Historical Odds Backfill

on:
  workflow_dispatch:
    inputs:
      season:
        description: 'Season year (e.g., 2024)'
        required: true
        default: '2024'
        type: string
      weeks:
        description: 'Week range (e.g., 2, 1-3, 2,3,5)'
        required: true
        default: '2'
        type: string
      markets:
        description: 'Markets to fetch (comma-separated)'
        required: false
        default: 'spreads,totals'
        type: string
      regions:
        description: 'Regions to fetch (comma-separated)'
        required: false
        default: 'us'
        type: string
      credits_limit:
        description: 'Maximum credits to use'
        required: false
        default: '3000'
        type: string
      dry_run:
        description: 'Dry run mode (no DB writes)'
        required: false
        default: 'false'
        type: boolean
      historical_strict:
        description: 'Enable strict historical mode'
        required: false
        default: 'true'
        type: boolean
      concurrency:
        description: 'Concurrency control (1-5)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'

concurrency:
  group: backfill-odds-${{ github.ref }}-${{ inputs.season }}-${{ inputs.weeks }}
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Print Node version
        run: node -v

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run prisma:generate

      - name: Build jobs
        run: npm run build:jobs

      - name: Verify build output
        run: |
          echo "Checking if compiled files exist..."
          ls -la apps/jobs/dist/
          echo "Checking for ingest-minimal.js..."
          if [ -f "apps/jobs/dist/ingest-minimal.js" ]; then
            echo "✅ ingest-minimal.js exists"
            echo "File size: $(wc -c < apps/jobs/dist/ingest-minimal.js) bytes"
            echo "First 5 lines:"
            head -5 apps/jobs/dist/ingest-minimal.js
          else
            echo "❌ ingest-minimal.js not found!"
            echo "Available files in dist/:"
            ls -la apps/jobs/dist/
            exit 1
          fi

      - name: Setup environment
        run: |
          echo "ODDS_API_KEY=${{ secrets.ODDS_API_KEY }}" >> $GITHUB_ENV
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "HISTORICAL_STRICT=${{ inputs.historical_strict }}" >> $GITHUB_ENV
          echo "HISTORICAL_ALLOWED_SEASON=${{ inputs.season }}" >> $GITHUB_ENV
          echo "HISTORICAL_ALLOWED_WEEKS=${{ inputs.weeks }}" >> $GITHUB_ENV
          echo "CREDITS_LIMIT=${{ inputs.credits_limit }}" >> $GITHUB_ENV

      - name: Test compiled file
        run: |
          echo "Testing compiled file with help command..."
          node apps/jobs/dist/ingest-minimal.js --help || echo "Help command failed, but continuing..."

      - name: Echo DB host (safety)
        run: |
          echo "DB_URL host: $(node -e "try{const u=new URL(process.env.DATABASE_URL||'');console.log(u.host)}catch(e){console.log('NO_DB_URL')}")"

      - name: Echo Prisma target
        run: |
          node -e "try{const u=new URL(process.env.DATABASE_URL||'');console.log({protocol:u.protocol,host:u.host,db:u.pathname})}catch(e){console.log('NO_DB_URL')}"

      - name: Run historical backfill
        run: |
          echo "Running historical backfill with parameters:"
          echo "Season: ${{ inputs.season }}"
          echo "Weeks: ${{ inputs.weeks }}"
          echo "Markets: ${{ inputs.markets }}"
          echo "Regions: ${{ inputs.regions }}"
          echo "Credits limit: ${{ inputs.credits_limit }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo "Historical strict: ${{ inputs.historical_strict }}"
          echo ""
          node apps/jobs/dist/ingest-minimal.js oddsapi \
            --season "${{ inputs.season }}" \
            --weeks "${{ inputs.weeks }}" \
            --markets "${{ inputs.markets }}" \
            --regions "${{ inputs.regions }}" \
            --credits-limit "${{ inputs.credits_limit }}" \
            --historical=${{ inputs.historical }} \
            --historical-strict=${{ inputs.historical_strict }} \
            --dry-run=${{ inputs.dry_run }}
        env:
          DEBUG: ingest:*,oddsapi:*,adapter:*
          NODE_OPTIONS: --trace-warnings

      - name: Post-run count for 2024 W2
        run: |
          node -e "const {PrismaClient}=require('@prisma/client');const p=new PrismaClient();(async()=>{const c=await p.marketLine.count({where:{season:2024,week:2}});console.log('Post-run market_lines count (2024,2):',c);process.exit(0)})().catch(e=>{console.error(e);process.exit(1)})"

      - name: Ensure artifacts exist
        run: |
          mkdir -p reports/historical
          touch reports/historical/map_2024_w2.jsonl
          touch reports/historical/errors_2024_w2.jsonl
          echo "Artifacts created:"
          ls -la reports/historical/

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: historical-reports-${{ inputs.season }}-w${{ inputs.weeks }}
          path: |
            reports/historical/
          retention-days: 30

      - name: Job summary
        if: always()
        run: |
          echo "## Historical Odds Backfill Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Season:** ${{ inputs.season }}" >> $GITHUB_STEP_SUMMARY
          echo "**Weeks:** ${{ inputs.weeks }}" >> $GITHUB_STEP_SUMMARY
          echo "**Markets:** ${{ inputs.markets }}" >> $GITHUB_STEP_SUMMARY
          echo "**Regions:** ${{ inputs.regions }}" >> $GITHUB_STEP_SUMMARY
          echo "**Credits Limit:** ${{ inputs.credits_limit }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "**Historical Strict:** ${{ inputs.historical_strict }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY