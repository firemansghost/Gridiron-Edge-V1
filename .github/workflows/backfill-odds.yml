name: Backfill Historical Odds (Manual)

on:
  workflow_dispatch:
    inputs:
      seasonFrom:
        description: 'Start season (e.g., 2023)'
        required: true
        type: string
      seasonTo:
        description: 'End season (e.g., 2024)'
        required: true
        type: string
      weeks:
        description: 'Weeks to backfill (e.g., 1-15 or 1,3,5)'
        required: true
        type: string
        default: '1-15'
      dryRun:
        description: 'Dry run (no database writes)'
        required: false
        type: boolean
        default: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
      ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
      ODDS_API_BASE_URL: https://api.the-odds-api.com/v4
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate

      - name: Check API key
        run: |
          if [ -z "$ODDS_API_KEY" ]; then
            echo "âŒ ODDS_API_KEY not set in GitHub Secrets"
            echo "This workflow requires The Odds API with historical data access (paid tier)"
            exit 1
          fi
          echo "âœ… ODDS_API_KEY is configured"

      - name: Run historical backfill
        run: |
          echo "ðŸ”„ Starting historical odds backfill..."
          echo "Seasons: ${{ inputs.seasonFrom }}-${{ inputs.seasonTo }}"
          echo "Weeks: ${{ inputs.weeks }}"
          echo "Dry Run: ${{ inputs.dryRun }}"
          
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dryRun }}" = "true" ]; then
            DRY_RUN_FLAG="--dryRun"
          fi
          
          npm run backfill:oddsapi -- \
            --seasons ${{ inputs.seasonFrom }}-${{ inputs.seasonTo }} \
            --weeks ${{ inputs.weeks }} \
            $DRY_RUN_FLAG

      - name: Verify results
        if: ${{ !inputs.dryRun }}
        run: |
          echo "ðŸ“Š Verifying backfilled data..."
          npm run verify:ingest

      - name: Summary
        if: always()
        run: |
          echo "## Backfill Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Seasons**: ${{ inputs.seasonFrom }}-${{ inputs.seasonTo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Weeks**: ${{ inputs.weeks }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dryRun }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed results." >> $GITHUB_STEP_SUMMARY

